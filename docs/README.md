# üé§ NPCL Asterisk ARI Voice Assistant

**A comprehensive, enterprise-grade voice assistant system powered by OpenAI's GPT-4 Realtime API, designed specifically for NPCL (Noida Power Corporation Limited) customer service with advanced real-time telephony integration.**

## ‚ú® **Project Overview**

The NPCL Voice Assistant is a sophisticated, production-ready voice interaction system that combines cutting-edge AI technology with enterprise telephony infrastructure. It provides seamless voice-based customer support for power utility services through multiple interaction channels.

### **üéØ Key Capabilities**

- ü§ñ **Advanced AI Integration**: OpenAI GPT-4 Realtime API for real-time conversational AI
- üìû **Enterprise Telephony**: Complete Asterisk ARI integration with bidirectional audio streaming
- üé§ **Real-time Audio Processing**: Voice Activity Detection with <20ms latency
- üåê **Multi-channel Support**: Phone calls, WebSocket, REST API, and web interfaces
- üó£Ô∏è **Multilingual Support**: Hindi, Bhojpuri, Bengali, and English
- üè¢ **NPCL-Specific Features**: Power utility customer service optimization
- üîí **Enterprise Security**: Production-ready security and authentication
- üìä **Comprehensive Monitoring**: Real-time metrics, logging, and performance tracking

## üöÄ **What's New in Version 2.0**

### **üéÜ Real-time Features**
- **OpenAI Realtime API Integration**: Direct voice-to-voice conversation with ultra-low latency
- **External Media Streaming**: Bidirectional audio via Asterisk externalMedia WebSocket
- **Voice Activity Detection**: Intelligent interruption handling for natural conversations
- **Session Management**: Advanced conversation state tracking and metrics

### **üèóÔ∏è Professional Architecture**
- **Modular Design**: Clean separation of concerns with 10+ specialized modules
- **Event-Driven Architecture**: Async processing with comprehensive event handling
- **Configuration Management**: Pydantic-based settings with environment isolation
- **Error Recovery**: Robust error handling with graceful degradation

### **üß™ Enterprise Testing**
- **200+ Test Cases**: Comprehensive test coverage across all components
- **Performance Testing**: Real-time latency and load testing
- **Integration Testing**: End-to-end workflow validation
- **Audio Testing**: Specialized voice activity detection testing

### **üê≥ Production Deployment**
- **Docker Support**: Multi-stage builds with security hardening
- **Kubernetes Ready**: Production orchestration with auto-scaling
- **Monitoring Stack**: Prometheus, Grafana, and comprehensive observability
- **CI/CD Integration**: Automated testing and deployment pipelines

## üìÅ **Project Architecture**

```
NPCL-Asterisk-ARI-Assistant/
‚îú‚îÄ‚îÄ src/voice_assistant/              # üéØ Core Application
‚îÇ   ‚îú‚îÄ‚îÄ core/                         # üß† Business Logic & Session Management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assistant.py              # Main VoiceAssistant orchestrator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session_manager.py        # Advanced session tracking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modern_assistant.py       # Modern AI integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ performance.py            # Performance monitoring
‚îÇ   ‚îú‚îÄ‚îÄ ai/                           # ü§ñ AI Services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai_realtime_client.py # Real-time OpenAI API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_client_factory.py      # AI client factory
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ function_calling.py       # AI tool integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ npcl_prompts.py           # NPCL-specific prompts
‚îÇ   ‚îú‚îÄ‚îÄ audio/                        # üéµ Audio Processing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ realtime_audio_processor.py  # Real-time audio pipeline
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ improved_vad.py           # Voice Activity Detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ multilingual_tts.py       # Multi-language TTS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ audio_utils.py            # Audio utilities
‚îÇ   ‚îú‚îÄ‚îÄ telephony/                    # üìû Telephony Integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ realtime_ari_handler.py   # Advanced ARI handler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ external_media_handler.py # WebSocket audio streaming
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rtp_streaming_handler.py  # RTP protocol handling
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ari_handler.py            # Base ARI implementation
‚îÇ   ‚îú‚îÄ‚îÄ tools/                        # üõ†Ô∏è External Tools
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ weather_tool.py           # Weather information tool
‚îÇ   ‚îú‚îÄ‚îÄ i18n/                         # üåê Internationalization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ locales/                  # Language-specific resources
‚îÇ   ‚îú‚îÄ‚îÄ observability/                # üìä Monitoring & Metrics
‚îÇ   ‚îú‚îÄ‚îÄ security/                     # üîí Security Components
‚îÇ   ‚îî‚îÄ‚îÄ utils/                        # üîß Utilities
‚îú‚îÄ‚îÄ config/                           # ‚öôÔ∏è Configuration
‚îÇ   ‚îî‚îÄ‚îÄ settings.py                   # Pydantic configuration management
‚îú‚îÄ‚îÄ tests/                            # üß™ Comprehensive Test Suite
‚îÇ   ‚îú‚îÄ‚îÄ unit/                         # Unit tests (11 files)
‚îÇ   ‚îú‚îÄ‚îÄ integration/                  # Integration tests (3 files)
‚îÇ   ‚îú‚îÄ‚îÄ e2e/                          # End-to-end tests
‚îÇ   ‚îú‚îÄ‚îÄ performance/                  # Performance & latency tests
‚îÇ   ‚îú‚îÄ‚îÄ audio/                        # Audio processing tests
‚îÇ   ‚îú‚îÄ‚îÄ websocket/                    # WebSocket communication tests
‚îÇ   ‚îú‚îÄ‚îÄ mocks/                        # Mock objects for testing
‚îÇ   ‚îî‚îÄ‚îÄ utils/                        # Test utilities
‚îú‚îÄ‚îÄ docs/                             # üìö Documentation
‚îÇ   ‚îú‚îÄ‚îÄ API_DOCUMENTATION.md         # Complete API reference
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md              # System architecture
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT.md                # Deployment guide
‚îÇ   ‚îú‚îÄ‚îÄ REALTIME_SETUP.md            # Real-time setup guide
‚îÇ   ‚îî‚îÄ‚îÄ COMPREHENSIVE_TEST_CASES_REPORT.md
‚îú‚îÄ‚îÄ docker/                           # üê≥ Docker Configuration
‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh                # Container initialization
‚îú‚îÄ‚îÄ kubernetes/                       # ‚ò∏Ô∏è Kubernetes Manifests
‚îú‚îÄ‚îÄ monitoring/                       # üìä Monitoring Configuration
‚îú‚îÄ‚îÄ asterisk-config/                  # üìû Asterisk Configuration
‚îú‚îÄ‚îÄ scripts/                          # üìú Utility Scripts
‚îî‚îÄ‚îÄ sounds/                           # üîä Audio Resources
```

## üõ†Ô∏è **Installation & Setup**

### **Prerequisites**

- **Python**: 3.8+ (3.11 recommended)
- **OpenAI API Key**: For GPT-4 Realtime API access
- **Asterisk**: 16.0+ with ARI enabled (for telephony features)
- **System**: 4GB RAM minimum, 8GB recommended
- **Network**: Stable internet for AI services

### **Quick Start**

```bash
# 1. Clone the repository
git clone <repository-url>
cd NPCL-Asterisk-ARI-Assistant

# 2. Create virtual environment
python -m venv .venv

# Activate virtual environment
# Linux/Mac:
source .venv/bin/activate
# Windows:
.venv\\Scripts\\activate

# 3. Install dependencies
pip install -r requirements.txt

# 4. Configure environment
cp .env.example .env
# Edit .env and add your OpenAI API key

# 5. Run the assistant
python src/main.py
```

### **Docker Deployment (Recommended)**

```bash
# Development environment
docker-compose up -d

# Production environment
docker-compose -f docker-compose.production.yml up -d

# Access the API
curl http://localhost:8000/health
```

## ‚öôÔ∏è **Configuration**

### **Environment Variables**

```bash
# Required - OpenAI API Key
OPENAI_API_KEY=your-openai-api-key-here

# AI Configuration
OPENAI_MODEL=gpt-4o-realtime-preview-2024-10-01
OPENAI_VOICE=alloy
MAX_TOKENS=150
TEMPERATURE=0.7

# Real-time Audio Settings
AUDIO_FORMAT=slin16
AUDIO_SAMPLE_RATE=16000
AUDIO_CHUNK_SIZE=320
VAD_ENERGY_THRESHOLD=300

# Assistant Configuration
ASSISTANT_NAME=NPCL Assistant
VOICE_LANGUAGE=en
LISTEN_TIMEOUT=20.0

# Telephony Configuration (Optional)
ARI_BASE_URL=http://localhost:8088/ari
ARI_USERNAME=asterisk
ARI_PASSWORD=1234
STASIS_APP=openai-voice-assistant

# External Media Configuration
EXTERNAL_MEDIA_HOST=localhost
EXTERNAL_MEDIA_PORT=8090

# Performance Settings
ENABLE_INTERRUPTION_HANDLING=true
MAX_CALL_DURATION=3600
AUTO_ANSWER_CALLS=true
```

### **Getting OpenAI API Key**

1. Visit [OpenAI Platform](https://platform.openai.com/)
2. Sign in with your OpenAI account
3. Create a new API key
4. Copy the key to your `.env` file

## üéØ **Usage Modes**

### **1. Standalone Voice Assistant**

```bash
python src/main.py
# Choose option 2 (Voice Mode) for full voice conversation
```

**Features:**
- üé§ Voice input with 15-second timeout
- üß† AI processing with OpenAI GPT-4 Realtime
- üó£Ô∏è Speech output with OpenAI TTS
- üìä Real-time status updates
- üìà Session statistics

### **2. Real-time Telephony Integration**

```bash
# Start real-time server
python src/run_realtime_server.py

# Or use the startup script
./start_realtime.sh
```

**Features:**
- üì° Bidirectional audio streaming via WebSocket
- üé§ Voice Activity Detection with interruption handling
- ‚ö° Ultra-low latency (<20ms audio processing)
- üîÑ Real-time conversation state management
- üìû Complete Asterisk ARI integration

### **3. API Server Mode**

```bash
# Start FastAPI server
uvicorn src.main:app --host 0.0.0.0 --port 8000
```

**Access Points:**
- üåê **API**: http://localhost:8000
- üìö **Documentation**: http://localhost:8000/docs
- üè• **Health Check**: http://localhost:8000/health
- üìä **Status**: http://localhost:8000/status

### **4. WebSocket Real-time Mode**

```javascript
// Connect to WebSocket for real-time interaction
const ws = new WebSocket('ws://localhost:8000/ws/voice/session_id');

// Send audio data
ws.send(JSON.stringify({
    type: 'audio_data',
    data: base64AudioData
}));
```

## üìû **Telephony Integration**

### **Test Extensions**

- **1000**: Main OpenAI Voice Assistant (full real-time integration)
- **1001**: External Media Test (direct WebSocket audio)
- **1002**: Basic Audio Test (echo and playback)
- **1003**: Conference Test
- **1004**: Recording Test

### **Asterisk Configuration**

```bash
# Copy Asterisk configuration
sudo cp asterisk-config/* /etc/asterisk/

# Restart Asterisk
sudo systemctl restart asterisk

# Test ARI connectivity
curl -u asterisk:1234 http://localhost:8088/ari/asterisk/info
```

## üß™ **Testing**

### **Run Test Suite**

```bash
# Run all tests (200+ test cases)
pytest tests/ -v

# Run specific test categories
pytest tests/unit/ -v                    # Unit tests
pytest tests/integration/ -v             # Integration tests
pytest tests/performance/ -v             # Performance tests
pytest tests/e2e/ -v                     # End-to-end tests

# Run with coverage
pytest tests/ --cov=src/voice_assistant --cov-report=html
```

### **Test Categories**

| Category | Files | Test Cases | Purpose |
|----------|-------|------------|----------|
| **Unit Tests** | 11 | 150+ | Component isolation testing |
| **Integration Tests** | 3 | 30+ | Component interaction testing |
| **E2E Tests** | 1 | 10+ | Complete workflow testing |
| **Performance Tests** | 1 | 15+ | Latency and load testing |
| **Audio Tests** | 1 | 10+ | Voice activity detection |
| **WebSocket Tests** | 1 | 10+ | Real-time communication |

## üìä **Monitoring & Observability**

### **Built-in Monitoring**

- **Real-time Metrics**: Performance and usage statistics
- **Health Checks**: Component status monitoring
- **Session Tracking**: Complete conversation analytics
- **Error Tracking**: Comprehensive error logging
- **Performance Monitoring**: Latency and throughput metrics

### **Production Monitoring Stack**

```bash
# Start monitoring stack (production)
docker-compose -f docker-compose.production.yml up -d

# Access monitoring dashboards
# Grafana: http://localhost:3000
# Prometheus: http://localhost:9090
```

**Available Dashboards:**
- üé§ Voice Assistant Performance
- üìû Asterisk Call Metrics
- üóÑÔ∏è Database Performance
- üîÑ Redis Cache Metrics
- üåê API Request Analytics

## üîí **Security Features**

### **Built-in Security**

- **API Key Authentication**: Secure OpenAI API integration
- **Input Validation**: Comprehensive input sanitization
- **Rate Limiting**: DDoS protection and abuse prevention
- **Secure Configuration**: Environment-based secrets management
- **Audit Logging**: Complete security event tracking

### **Production Security**

```bash
# Enable security features
ENABLE_RATE_LIMITING=true
ENABLE_INPUT_SANITIZATION=true
ENABLE_AUDIT_LOGGING=true

# Configure SSL/TLS
# See deployment documentation for details
```

## üåê **Multilingual Support**

### **Supported Languages**

- **English (en-IN)**: Primary language
- **Hindi (hi-IN)**: Full support with native TTS
- **Bhojpuri (bho-IN)**: Regional language support
- **Bengali (bn-IN)**: Eastern region support

### **Language Configuration**

```bash
# Set default language
VOICE_LANGUAGE=hi

# Enable multilingual detection
ENABLE_LANGUAGE_DETECTION=true
```

## üè¢ **NPCL-Specific Features**

### **Power Utility Services**

- **Bill Inquiries**: Electricity bill status and payment
- **Outage Reporting**: Power outage reporting and tracking
- **Connection Services**: New connection requests
- **Complaint Management**: Customer complaint handling
- **Service Areas**: Noida, Greater Noida, Ghaziabad coverage

### **Customer Service Optimization**

```python
# NPCL-specific prompts and responses
from voice_assistant.ai.npcl_prompts import NPCLPrompts

# Specialized customer service workflows
# Automated complaint registration
# Bill payment assistance
# Service request handling
```

## üöÄ **Performance Specifications**

### **Real-time Performance**

| Metric | Target | Production Requirement |
|--------|--------|------------------------|
| **Audio Processing Latency** | <20ms | Critical for real-time |
| **VAD Processing** | <10ms | Voice Activity Detection |
| **Session Creation** | <100ms | Session management |
| **WebSocket Response** | <100ms | Real-time communication |
| **Memory Usage** | <100MB per session | Production target |
| **CPU Usage** | <80% | Under normal load |

### **Quality Metrics**

| Metric | Target | Description |
|--------|--------|-------------|
| **Audio Quality Preservation** | >95% | Energy retention |
| **Speech Detection Accuracy** | >90% | Precision |
| **Silence Detection Accuracy** | >95% | Precision |
| **Error Rate** | <1% | Production deployment |
| **Concurrent Sessions** | 100+ | Simultaneous calls |

## üîß **Development**

### **Development Setup**

```bash
# Install development dependencies
pip install -r requirements-test.txt

# Install pre-commit hooks
pre-commit install

# Run code formatting
black src/
flake8 src/

# Run type checking
mypy src/
```

### **Code Quality Standards**

- **Type Safety**: Comprehensive type hints throughout
- **Code Formatting**: Black for consistent formatting
- **Linting**: Flake8 for code quality
- **Documentation**: Docstrings for all classes and methods
- **Testing**: Minimum 90% test coverage

### **Adding Features**

The modular architecture makes it easy to extend:

```python
# Add new AI provider
from voice_assistant.ai.base_client import BaseAIClient

class NewAIClient(BaseAIClient):
    def generate_response(self, text: str) -> str:
        # Your implementation
        pass

# Add new audio processor
from voice_assistant.audio.base_processor import BaseAudioProcessor

class NewAudioProcessor(BaseAudioProcessor):
    def process_audio(self, audio_data: bytes) -> str:
        # Your implementation
        pass
```

## üê≥ **Docker Deployment**

### **Development Deployment**

```bash
# Start development environment
docker-compose up -d

# View logs
docker-compose logs -f voice-assistant

# Stop services
docker-compose down
```

### **Production Deployment**

```bash
# Set environment variables
export OPENAI_API_KEY=\"your-key\"
export DB_PASSWORD=\"secure-password\"

# Start production stack
docker-compose -f docker-compose.production.yml up -d

# Monitor deployment
docker-compose -f docker-compose.production.yml logs -f
```

### **Kubernetes Deployment**

```bash
# Deploy to Kubernetes
kubectl apply -f kubernetes/

# Check deployment status
kubectl get pods -n voice-assistant

# Scale deployment
kubectl scale deployment voice-assistant --replicas=5
```

## üö® **Troubleshooting**

### **Common Issues**

1. **OpenAI API Key Issues**:
   ```bash
   # Verify API key
   python -c \"import openai; openai.api_key='your-key'; print('Valid')\"
   ```

2. **Audio Processing Issues**:
   ```bash
   # Check audio dependencies
   python -c \"import pyaudio; import pydub; print('Audio OK')\"
   ```

3. **Asterisk Connection Issues**:
   ```bash
   # Test ARI connectivity
   curl -u asterisk:1234 http://localhost:8088/ari/asterisk/info
   ```

### **Debug Mode**

```bash
# Enable debug logging
LOG_LEVEL=DEBUG

# Enable performance monitoring
ENABLE_PERFORMANCE_MONITORING=true

# Run with verbose output
python src/main.py --debug
```

## üìö **Documentation**

### **Complete Documentation Set**

- **[API Documentation](API_DOCUMENTATION.md)**: Complete API reference
- **[Architecture Guide](ARCHITECTURE.md)**: System architecture and design
- **[Deployment Guide](DEPLOYMENT.md)**: Production deployment instructions
- **[Real-time Setup](REALTIME_SETUP.md)**: Real-time integration guide
- **[Test Cases Report](COMPREHENSIVE_TEST_CASES_REPORT.md)**: Complete testing documentation
- **[Docker Guide](../DOCKER_DEPLOYMENT_GUIDE.md)**: Docker deployment guide

### **Additional Resources**

- **[Technical Assessment](../TECHNICAL_EXPERT_ASSESSMENT.md)**: Expert technical evaluation
- **[Feature Verification](../FEATURE_VERIFICATION_REPORT.md)**: Feature implementation verification
- **[Agents Guide](../AGENTS.md)**: Development guidelines

## ü§ù **Contributing**

### **Development Workflow**

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/amazing-feature`
3. Make your changes with proper tests
4. Run the test suite: `pytest tests/`
5. Commit: `git commit -m 'Add amazing feature'`
6. Push: `git push origin feature/amazing-feature`
7. Open a Pull Request

### **Code Standards**

- Follow PEP 8 style guidelines
- Add type hints for all functions
- Write comprehensive docstrings
- Include unit tests for new features
- Update documentation as needed

## üìÑ **License**

This project is licensed under the MIT License. See the [LICENSE](../LICENSE) file for details.

## üìû **Support**

### **Getting Help**

- üìö **Documentation**: Check the comprehensive docs/ directory
- üêõ **Issues**: Report bugs on GitHub Issues
- üí° **Features**: Request features on GitHub Discussions
- üìß **Contact**: Open an issue for support questions

### **Community**

- **GitHub Discussions**: For questions and community support
- **Issue Tracker**: For bug reports and feature requests
- **Documentation**: Comprehensive guides and API reference

---

## üéâ **Ready to Get Started?**

```bash
# Quick start for voice interaction
cp .env.example .env
# Add your OpenAI API key to .env
python src/main.py
# Choose option 2 (Voice Mode)
# Start speaking - full conversation ready! üé§
```

**Your NPCL Voice Assistant is production-ready and fully functional! üöÄ**

---

**üìù Last Updated**: December 2024  
**üéØ Version**: 2.0  
**üè¢ Organization**: NPCL (Noida Power Corporation Limited)  
**‚≠ê Status**: Production Ready